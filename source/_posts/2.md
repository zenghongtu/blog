---
title: ä½¿ç”¨ Taro Hooks å¿«é€Ÿå¼€å‘ä¸€ä¸ªå°ç¨‹åº-- GitHub Pro
tags:
  - å‰ç«¯
  - å°ç¨‹åº
updated: '2022-07-08T09:22:22Z'
date: 2019-09-19 00:47:49
---

åœ¨ Taro Hooks å‡ºæ¥ ä¹‹åå°±ä¸€ç›´æƒ³ç€ä½“éªŒä¸€æ³¢ Hooks å°ç¨‹åºå¼€å‘ï¼Œä¸è¿‡ä¸€ç›´å¿™ç€è¡¥ç•ª ğŸ˜Œã€‚æœ€è¿‘è¡¥å®Œäº†ï¼Œå°±æäº†èµ·æ¥ï¼Œå¼€å‘äº† 20 å¤©å·¦å³ï¼ˆå…¶å®å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨æ”¹ UIğŸ˜’ï¼‰ï¼ŒåŸºæœ¬ä¸Šæ˜¯å®Œæˆäº†ï¼Œç„¶åä¹Ÿä¸Šæ¶äº†ï¼Œé‚è·Ÿå¤§å®¶åˆ†äº«ä¸€ç‚¹å¿ƒå¾— ğŸ˜ˆ

å¯ä»¥å…ˆæ‰«æä½“éªŒï¼š

![qrcode](https://user-images.githubusercontent.com/25629121/65200589-fa9e6400-dab9-11e9-8188-df997c1653e0.jpg)


ç½‘ç»œä¸ç¨³å®šçš„å°ä¼™ä¼´çœ‹é¢„è§ˆï¼š

![github-pro](https://user-images.githubusercontent.com/25629121/65200598-ff631800-dab9-11e9-93b0-58961080268c.gif)


åœ¨ GitHub Pro çš„å¼€å‘ä¸­ï¼Œæˆ‘å†™äº†å››ä¸ª hooksï¼Œæ¥å¸®åŠ©æˆ‘æé«˜å¼€å‘æ•ˆç‡

- useRequest
- useRequestWithMore
- useReachBottomEvent
- usePullDownRefreshEvent

æ¥ä¸‹æ¥å°±åˆ†æä¸€ä¸‹å®ƒä»¬çš„ä½œç”¨

## useRequest

ä½œç”¨åŒåå­—ï¼Œç”¨æ¥è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œä¼ å…¥è¯·æ±‚å‚æ•°ä»¥åŠè¿›è¡Œè¯·æ±‚çš„å‡½æ•°ï¼Œå­˜å‚¨æ•°æ®ï¼Œè¿”å› `[currData, refresh]` ï¼Œå…¶ä¸­`currData`æ˜¯å­˜å‚¨çš„è¿”å›æ•°æ®ï¼Œ`refresh`ç”¨äºåˆ·æ–°è¯·æ±‚ã€‚

```
function useRequest<T>(
  params: any,
  request: (params: any) => Promise<T | null>
): [T | null, () => void] | [] {
  const [currData, setData] = useState<T | null>(null)
  const [count, setCount] = useState(0)
  const pagePullDownRef = useRef('')

  useEffect(() => {
    request(params).then(data => {
      if (data) {
        setData(data)
      }
    })
  }, [count])

  usePullDownRefresh(() => {
    refresh()
  })

  useEffect(() => {
    events.on(PULL_DOWN_REFRESH_EVENT, (page: string) => {
      if (!pagePullDownRef.current) {
        pagePullDownRef.current = page
      } else if (pagePullDownRef.current !== page) {
        return
      }
      refresh()
    })
    return () => {
      events.off(PULL_DOWN_REFRESH_EVENT)
    }
  }, [])

  const refresh = () => {
    setCount(count + 1)
  }

  return [currData, refresh]
}

export default useRequest
```

[useRequest](https://github.com/zenghongtu/GitHub-Pro/blob/master/client/src/hooks/useRequest.ts)

## useRequestWithMore

è¿™ä¸ªé’©å­æ˜¯æœ€å¤æ‚çš„ä¸€ä¸ªï¼Œä¹Ÿæ˜¯ä½œç”¨æœ€å¤§çš„ä¸€ä¸ªå‡½æ•°ã€‚èƒ½å¤Ÿåœ¨æ»šåŠ¨æ¡åˆ°åº•åº•éƒ¨çš„æ—¶å€™ï¼Œè¯·æ±‚ä¸‹ä¸€é¡µï¼ŒåŠ è½½æ›´å¤šçš„æ•°æ®ã€‚

```
function useRequestWIthMore<T, S = string>(
  data: S,
  request: (data: S, params: any | null) => Promise<T[] | null>
): [T[] | null, boolean, () => void, () => void] | [] {
  if (!data) {
    // bug?
    console.warn('useRequestWIthMore: no data')
    return []
  }

  const [currData, setData] = useState<T[] | null>(null)
  const [hasMore, setHasMore] = useState<boolean>(true)
  const [params, setParams] = useState(defaultParams)
  const loadingRef = useRef(false)

  useEffect(() => {
    if (hasMore) {
      loadingRef.current = true
      request(data, params)
        .then(data => {
          if (data) {
            if (currData) {
              setData([...currData, ...data])
            } else {
              setData(data)
            }
            if (data.length < params.per_page!) {
              setHasMore(false)
            }
          }
        })
        .finally(() => {
          loadingRef.current = false
          Taro.stopPullDownRefresh()
          Taro.hideLoading()
        })
    }
  }, [params])

  usePullDownRefresh(() => {
    refresh()
  })

  useReachBottom(() => {
    if (loadingRef.current) {
      return
    }
    getMoreData()
  })

  const getMoreData = () => {
    setParams(params => ({ ...params, page: params.page! + 1 }))
  }

  const refresh = () => {
    setData(null)
    setHasMore(true)
    setParams({ ...params, page: 1 })
  }

  return [currData, hasMore, refresh, getMoreData]
}
```

æ˜¯ä¸æ˜¯å¾ˆå®Œç¾ï¼Œå¯æƒœä¸æ˜¯è¿™ä¹ˆç®€å•ã€‚

Taro ä¸­æœ‰ä¸ªå¤§å‘å°±æ˜¯åœ¨ç»„ä»¶ä¸­æ— æ³•ä½¿ç”¨å¦‚`usePullDownRefresh`ã€`useReachBottom`ç­‰é’©å­ã€‚

æ‰€ä»¥å°±å¼•å‡ºæ¥ä¸€ä¸ªå¤§é—®é¢˜ -- å¦‚ä½•åœ¨ç»„ä»¶ä¸­è§¦å‘è¿™äº›æ“ä½œå‘¢ã€‚è€Œä¸”åœ¨ GitHub Pro ä¸­ï¼Œæˆ‘æŠŠå¾ˆå¤šç»„ä»¶è¿›è¡Œäº†æ‹†åˆ†ï¼Œéš¾é“æˆ‘è¦é‡å†™ï¼ŸğŸ˜‘

è¿™è‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚è¿˜å¥½è´´å¿ƒçš„ Taro ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ¶ˆæ¯æœºåˆ¶(å®é™…ä¸Šå°±æ˜¯å‘å¸ƒè®¢é˜…)ï¼Œå¯ä»¥ç”¨å®ƒæ¥è§£å†³æˆ‘ä»¬å½“å‰é‡åˆ°çš„é—®é¢˜ã€‚

```
 // å­˜å‚¨å”¯ä¸€ id ç”¨äºåŒ¹é…æ¶ˆæ¯
  const pageReachBottomRef = useRef('')
  const pagePullDownRef = useRef('')

  useEffect(() => {
    events.on(REACH_BOTTOM_EVENT, (page: string) => {
      if (loadingRef.current) {
        return
      }
      if (!pageReachBottomRef.current) {
        pageReachBottomRef.current = page
      } else if (pageReachBottomRef.current !== page) {
        return
      }
      getMoreData()
    })
    return () => {
      events.off(REACH_BOTTOM_EVENT)
    }
  }, [])

  useEffect(() => {
    events.on(PULL_DOWN_REFRESH_EVENT, (page: string) => {
      if (!pagePullDownRef.current) {
        pagePullDownRef.current = page
      } else if (pagePullDownRef.current !== page) {
        return
      }
      refresh()
    })
    return () => {
      events.off(PULL_DOWN_REFRESH_EVENT)
    }
  }, [])
```

å…¶ä¸­`pageReachBottomRef`ã€`pagePullDownRef`éå¸¸å…³é”®ï¼Œç”¨æ¥å¯¹æ¶ˆæ¯è¿›è¡Œé…å¯¹ï¼Œé˜²æ­¢è¯´æˆ‘è¿™ä¸ªé¡µé¢æ»šåŠ¨ï¼Œå¯¼è‡´å¦å¤–ä¸€ä¸ªé¡µé¢ä¹Ÿè¿›è¡Œæ•°æ®çš„è¯·æ±‚ã€‚

[useRequestWIthMore](https://github.com/zenghongtu/GitHub-Pro/blob/master/client/src/hooks/useRequestWIthMore.ts)

## usePullDownRefreshEvent

è¿™ä¸ªé’©å­ç”¨æ¥åšå½“ä¸‹æ‹‰åˆ·æ—¶å€™å‘é€åˆ·æ–°é¡µé¢çš„æ¶ˆæ¯ï¼ˆåœ¨ page å†…ä½¿ç”¨ï¼‰ï¼Œè€Œæ¥å—è€…å°±å‰é¢`useRequestWithMore`äº†

```
function usePullDownRefreshEvent() {
  const pageRef = useRef(getUniqueId())
  usePullDownRefresh(() => {
    events.trigger(PULL_DOWN_REFRESH_EVENT, pageRef.current)
  })

  return null
}
```

[usePullDownRefreshEvent](https://github.com/zenghongtu/GitHub-Pro/blob/master/client/src/hooks/usePullDownRefreshEvent.ts)

## useReachBottomEvent

è¿™ä¸ªé’©å­ç”¨æ¥åšå½“é¡µé¢æ»šåŠ¨åˆ°åº•éƒ¨æ—¶å€™å‘é€è·å–æ•°æ®çš„æ¶ˆæ¯ï¼ˆåœ¨ page å†…ä½¿ç”¨ï¼‰ï¼Œè€Œæ¥å—è€…å°±å‰é¢`useRequestWithMore`äº†ï¼Œå¹¶ä¸”æˆ‘åœ¨å†…éƒ¨åšäº†ä¸€ä¸‹èŠ‚æµã€‚

```
function useReachBottomEvent() {
  const pageRef = useRef(getUniqueId())
  const timerRef = useRef(0)

  useReachBottom(() => {
    const prev = timerRef.current
    const curr = +Date.now()
    if (!prev || curr - prev > THROTTLE_DELAY) {
      events.trigger(REACH_BOTTOM_EVENT, pageRef.current)
      timerRef.current = curr
    } else {
      console.log('wait...')
    }
  })

  return null
}
```

## æ€»ç»“

åœ¨ GitHub Pro å¼€å‘ä¸­ï¼Œä½¿ç”¨ Hooks èƒ½å¤Ÿæé«˜é€»è¾‘çš„å¤ç”¨ï¼Œå¤§å¤§åŠ å¿«å¼€å‘çš„é€Ÿåº¦,ç›®å‰æˆ‘è¿˜æ²¡æœ‰é‡åˆ°è¿‡ä»€ä¹ˆå¤§å‘ï¼Œæ‰€ä»¥å¼€å‘ä½“éªŒè¿˜æ˜¯ä¸é”™çš„ã€‚

æ¨èèµ„æ–™:

- [Hooks Â· Taro](https://taro-docs.jd.com/taro/docs/hooks.html)
- [ä½¿ç”¨ React Hooks é‡æ„ä½ çš„å°ç¨‹åº](https://aotu.io/notes/2019/07/10/taro-hooks/index.html)

ä»¥ä¸Šæˆ‘ä¸»è¦è®²äº†å¦‚ä½•å†™ Hooksï¼Œè€Œç¼–å†™ä¹‹åçš„ä½¿ç”¨ï¼Œå¯ä»¥è‡ªè¡Œçœ‹é¡¹ç›®çš„ä»£ç 

Repo: [zenghongtu/GitHub-Pro](https://github.com/zenghongtu/GitHub-Pro)
